{% extends 'base.html' %}
{% block content %}
<div class="card p-4 mx-auto" style="max-width: 600px;">
    <h2 class="card-title text-center mb-4">Voting Results</h2>

    <div id="loading-message" class="text-center text-muted mb-3" style="display: none;">Loading results...</div>

    <ul class="list-group list-group-flush" id="results-list">
        <li class="list-group-item text-center text-muted" id="initial-message">No votes cast yet or fetching results...</li>
    </ul>
    <div class="text-center mt-3">
        <button class="btn btn-secondary" id="refresh-results">Refresh Results</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function fetchResults() {
        const loadingMessage = document.getElementById('loading-message');
        const initialMessage = document.getElementById('initial-message');
        const resultsList = document.getElementById('results-list');

        loadingMessage.style.display = 'block'; // Show loading message
        if (initialMessage) { // Hide initial message if it exists
            initialMessage.style.display = 'none';
        }
        resultsList.innerHTML = ''; // Clear existing results, but not the loading message

        fetch('/api/results')
            .then(response => {
                if (!response.ok) {
                    // If response is not OK (e.g., 500 error), throw an error
                    // This will be caught by the .catch block
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                let hasResults = false;
                for (const candidate in data) {
                    if (data.hasOwnProperty(candidate)) {
                        resultsList.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                            ${candidate}
                            <span class="badge bg-primary rounded-pill">${data[candidate]} vote(s)</span>
                        </li>`;
                        hasResults = true;
                    }
                }
                if (!hasResults) {
                    resultsList.innerHTML = `<li class="list-group-item text-center text-muted">No votes cast yet.</li>`;
                }
                loadingMessage.style.display = 'none'; // Hide loading message
            })
            .catch(error => {
                console.error('Error fetching results:', error);
                resultsList.innerHTML = `<li class="list-group-item text-center text-danger">Error loading results. Please check server logs.</li>`;
                loadingMessage.style.display = 'none'; // Hide loading message
            });
    }

    // Fetch results when the page loads
    document.addEventListener('DOMContentLoaded', fetchResults);

    // Fetch results when refresh button is clicked
    document.getElementById('refresh-results').addEventListener('click', fetchResults);

    // Optional: Auto-refresh every few seconds (e.g., every 5 seconds)
    // setInterval(fetchResults, 5000);
</script>
{% endblock %}